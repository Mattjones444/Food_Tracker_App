<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Food Tracker</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
        integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"/>
        <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

</head>
<body>

    <!-- Top Nav -->
    <div class="top-nav">Food Tracker</div>

    <!-- Main Content -->
    <div class="content">
        <h2>Welcome <span th:text="${username}">User</span>!</h2>
    </div>

    <div class="carousel-section">
        <h3>Popular actions</h3>
        <div class="carousel">
            <!-- Changed Add an item to button to open modal -->
            <div class="card">
                <button id="openModalBtn" style="background:none; border:none; color:blue; cursor:pointer; font-size:1rem;">
                    Add an item
                </button>
            </div>
            <div class="card">
                <a th:href="@{/pantry}">View my pantry</a>
            </div>
            <div class="card">
                <a th:href="@{/item/delete}">Delete an item</a>
            </div>
            <div class="card">
                <a th:href="@{/list}">View Shopping list</a>
            </div>
        </div>
    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav">
        <a th:href="@{/}">
            <i class="fas fa-home"></i> Home
        </a>
        <a th:href="@{/pantry}">
            <i class="fas fa-warehouse"></i> Pantry
        </a>
        <a th:href="@{/list}">
            <i class="fas fa-list"></i> List
        </a>
    </div>

    <!-- Modal for Barcode Scanning -->
    <div id="barcodeModal" class="modal">
        <div class="modal-content">
            <span id="closeModalBtn" class="close-btn">&times;</span>
            <h3>Scan barcode</h3>
            <div id="scanner">
                Camera preview will go here
            </div>
            <button id="confirmBtn" class="confirm-btn" disabled>Confirm product</button>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
  const modal = document.getElementById('barcodeModal');
  const openBtn = document.getElementById('openModalBtn');
  const closeBtn = document.getElementById('closeModalBtn');
  const confirmBtn = document.getElementById('confirmBtn');
  const scannerDiv = document.getElementById('scanner');

  let html5QrcodeScanner;
  let scannedCode = null;
  let scannerStopped = false;

  // Start the scanner
  const startScanner = () => {
    scannerStopped = false;
    scannedCode = null;
    confirmBtn.disabled = true;
    scannerDiv.textContent = '';

    html5QrcodeScanner = new Html5Qrcode("scanner");
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };

    html5QrcodeScanner.start(
      { facingMode: "environment" },
      config,
      (decodedText, decodedResult) => {
        console.log(`Code matched = ${decodedText}`);
        scannedCode = decodedText;
        scannerDiv.textContent = decodedText;
        confirmBtn.disabled = false;
        stopScanner();
      },
      (errorMessage) => {
        // Just log scan errors (normal when no QR code in frame)
        console.warn(`Scan error: ${errorMessage}`);
      }
    ).catch(err => {
      console.error(`Error starting scanner: ${err}`);
    });
  };

  // Stop the scanner safely
  const stopScanner = () => {
    if (!html5QrcodeScanner || scannerStopped) return;
    scannerStopped = true;

    html5QrcodeScanner.stop()
      .then(() => {
        console.log("Scanner stopped.");
        const scannerContainer = document.getElementById("scanner");
        if (scannerContainer && scannerContainer.hasChildNodes()) {
          return html5QrcodeScanner.clear().then(() => {
            console.log("Scanner cleared.");
          });
        } else {
          console.warn("Scanner container already empty, skipping clear.");
        }
      })
      .catch(err => {
        console.warn("Error stopping scanner:", err);
      });
  };

  // Open modal and start scanning
  openBtn.addEventListener('click', () => {
    modal.style.display = 'block';
    startScanner();
  });

  // Close modal and stop scanning
  closeBtn.addEventListener('click', () => {
    modal.style.display = 'none';
    stopScanner();
  });

  // Close modal on outside click
  window.addEventListener('click', (event) => {
    if (event.target === modal) {
      modal.style.display = 'none';
      stopScanner();
    }
  });

  // Confirm button - use scannedCode variable here
  confirmBtn.addEventListener('click', () => {
    if (scannedCode) {
      alert(`Product confirmed! Barcode: ${scannedCode}`);
      // TODO: Send scannedCode to backend or process further here
    } else {
      alert('No barcode scanned yet!');
    }
    modal.style.display = 'none';
    stopScanner();
  });
</script>



</body>
</html>

